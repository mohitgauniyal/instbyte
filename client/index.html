<!DOCTYPE html>
<html>
<head>
  <title>Instbyte</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{
      font-family: system-ui;
      background:#f3f4f6;
      margin:0;
    }
    header{
      background:#111827;
      color:#fff;
      padding:14px 20px;
      font-weight:600;
      letter-spacing:.5px;
    }
    .container{
      max-width:900px;
      margin:20px auto;
      padding:0 12px;
    }
    .channels button{
      margin-right:8px;
      padding:8px 14px;
      border:none;
      background:#e5e7eb;
      cursor:pointer;
      border-radius:6px;
    }
    .channels .active{
      background:#111827;
      color:#fff;
    }
    .composer{
      background:#fff;
      padding:12px;
      border-radius:8px;
      margin-top:12px;
      display:flex;
      gap:8px;
    }
    input[type=text]{
      flex:1;
      padding:10px;
      border:1px solid #ddd;
      border-radius:6px;
    }
    button{
      padding:10px 14px;
      border:none;
      background:#111827;
      color:#fff;
      border-radius:6px;
      cursor:pointer;
    }
    .drop{
      border:2px dashed #ccc;
      padding:18px;
      margin-top:12px;
      text-align:center;
      background:#fff;
      border-radius:8px;
    }
    .item{
      background:#fff;
      padding:12px;
      margin-top:10px;
      border-radius:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .meta{
      font-size:12px;
      color:#6b7280;
    }
    .left{
      max-width:70%;
      word-break:break-word;
    }
    .del{
      background:#ef4444;
      padding:6px 10px;
      font-size:12px;
    }
  </style>
</head>
<body>

<header style="display:flex;justify-content:space-between;align-items:center">
  <div>Instbyte</div>

  <div style="font-size:13px">
    <span id="who"></span>
    <button onclick="changeName()" style="margin-left:8px;background:#374151;padding:6px 10px;font-size:12px">
      change
    </button>
  </div>
</header>



<div class="container">

<div class="channels">
  <button onclick="setChannel('general')" id="ch-general">General</button>
  <button onclick="setChannel('dev')" id="ch-dev">Dev</button>
  <button onclick="setChannel('design')" id="ch-design">Design</button>
  <button onclick="setChannel('temp')" id="ch-temp">Temp</button>
</div>

<div style="margin-top:10px;">
  <input id="search" placeholder="Searchâ€¦" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd">
</div>

<div class="composer">
  <input id="msg" placeholder="Type message or paste link" onkeydown="handleEnter(event)"/>
  <button onclick="sendText()">Send</button>
  <input type="file" id="fileInput" hidden>
  <button onclick="fileInput.click()">Upload</button>
</div>

<div class="drop" id="drop">
  Drag & drop files here
</div>

<div id="items"></div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let channel = "general";

let uploader = localStorage.getItem("name");

if(!uploader || uploader === "null" || uploader.trim() === ""){
  uploader = prompt("Your name?");
  if(!uploader) uploader = "anon";
  localStorage.setItem("name", uploader);
}

document.getElementById("who").innerText = "You: " + uploader;

function highlight(){
  document.querySelectorAll(".channels button")
    .forEach(b=>b.classList.remove("active"));
  document.getElementById("ch-"+channel).classList.add("active");
}

function setChannel(c){
  channel=c;
  document.getElementById("search").value="";
  highlight();
  load();
}

highlight();

async function load(){
  const res = await fetch("/items/"+channel);
  const data = await res.json();
  render(data);
}

function render(data){
  const el=document.getElementById("items");
  el.innerHTML="";

  data.forEach(i=>{
    const div=document.createElement("div");
    div.className="item";

    let content="";

    if(i.type==="file"){
      const isImg = i.filename.match(/\.(jpg|png|jpeg|gif)$/i);
      if(isImg){
        content=`<img src="/uploads/${i.filename}" style="max-width:200px;border-radius:6px"><br>
        <a href="/uploads/${i.filename}" target="_blank">${i.filename}</a>`;
      }else{
        content=`<a href="/uploads/${i.filename}" target="_blank">${i.filename}</a>`;
      }
    }else{
      const isLink = i.content.startsWith("http");
      if(isLink){
        content=`<a href="${i.content}" target="_blank">${i.content}</a>`;
      }else{
        content=i.content;
      }
    }

    const pinText = i.pinned ? "unpin" : "pin";

    div.innerHTML=`
      <div class="left">
        ${content}
        <div class="meta">${i.uploader}</div>
      </div>
      <div>
        <button onclick="pin(${i.id})">${pinText}</button>
        <button class="del" onclick="del(${i.id})">delete</button>
      </div>
    `;

    el.appendChild(div);
  });
}


async function sendText(){
  const input=document.getElementById("msg");
  const text=input.value.trim();
  if(!text) return;

  await fetch("/text",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({content:text,channel,uploader})
  });

  input.value="";
}

function handleEnter(e){
  if(e.key === "Enter"){
    sendText();
  }
}

function changeName(){
  const n = prompt("Enter name:");
  if(!n) return;
  uploader = n;
  localStorage.setItem("name", n);
  document.getElementById("who").innerText = "You: " + uploader;
}

const fileInput=document.getElementById("fileInput");
fileInput.onchange=async ()=>{
  const file=fileInput.files[0];
  const form=new FormData();
  form.append("file",file);
  form.append("channel",channel);
  form.append("uploader",uploader);
  await fetch("/upload",{method:"POST",body:form});
};

const drop=document.getElementById("drop");

drop.addEventListener("dragover",e=>e.preventDefault());

drop.addEventListener("drop",async e=>{
  e.preventDefault();
  const file=e.dataTransfer.files[0];
  const form=new FormData();
  form.append("file",file);
  form.append("channel",channel);
  form.append("uploader",uploader);
  await fetch("/upload",{method:"POST",body:form});
});

async function del(id){
  await fetch("/item/"+id,{method:"DELETE"});
}

async function pin(id){
  await fetch("/pin/"+id,{method:"POST"});
  load();
}

socket.on("new-item", item=>{
  if(item.channel===channel) load();
});

socket.on("delete-item", id=>{
  load();
});

document.getElementById("search").addEventListener("input", async e=>{
  const q=e.target.value.trim();
  if(!q){
    load();
    return;
  }
  const res=await fetch(`/search/${channel}/${q}`);
  const data=await res.json();
  render(data);
});

document.addEventListener("paste", async e=>{
  const active = document.activeElement;

  // if user is typing in input, don't auto-send
  if(active && active.id === "msg") return;

  const text = e.clipboardData.getData("text");
  if(!text) return;

  await fetch("/text",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      content:text,
      channel,
      uploader
    })
  });
});

load();
</script>

</body>
</html>
